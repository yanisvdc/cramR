<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using cram_simulation() for CRAM with Known DGP â€¢ cramR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using cram_simulation() for CRAM with Known DGP">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Load Inter font --><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&amp;display=swap" rel="stylesheet">
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #2c3e50, #3498db);
    --hover-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }

  .navbar {
    background-color: rgba(255, 255, 255, 0.95); /* Light background with slight transparency */
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); /* Optional shadow for depth */
  }

  body {
    padding-top: 80px;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }

  h1, h2, h3, h4, h5, h6 {
    font-family: 'Inter', sans-serif;
  }

  code, pre, kbd {
    font-family: 'JetBrains Mono', monospace;
    background-color: #f5f5f5;
    padding: 0.2em 0.4em;
    border-radius: 4px;
    font-size: 90%;
  }

  pre {
    overflow-x: auto;
  }

  pre code {
    padding: 1em;
    display: block;
  }

  .navbar-brand img {
    height: 40px;
    transition: transform 0.3s ease;
  }

  .navbar-brand:hover img {
    transform: scale(1.05);
  }

  .hero-banner {
    background: var(--primary-gradient);
    padding: 6rem 1rem;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .feature-card {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin: 1rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }

  .feature-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--hover-shadow);
  }

  /* Add hover effect to make the navbar more readable */
  .navbar:hover {
    background-color: rgba(255, 255, 255, 1); /* Fully visible on hover */
  }

  /* Add space below the navbar to prevent cutting off content */
  main {
    padding-top: 1rem;
  }
</style>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cramR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/cram_policy.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/quickstart.html">Quick Start</a></li>
    <li><a class="dropdown-item" href="../articles/cram_ml.html">Cram ML</a></li>
    <li><a class="dropdown-item" href="../articles/cram_bandit.html">Cram Bandit</a></li>
    <li><a class="dropdown-item" href="../articles/cram_bandit_helpers.html">Cram Bandit Helpers</a></li>
    <li><a class="dropdown-item" href="../articles/cram_learning.html">Cram Policy Learning</a></li>
    <li><a class="dropdown-item" href="../articles/cram_ml_learning.html">Cram ML Learning</a></li>
    <li><a class="dropdown-item" href="../articles/cram_policy_simulation.html">Cram Policy Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/cram_bandit_simulation.html">Cram Bandit Simulation</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-resources" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Resources</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-resources">
<li><a class="dropdown-item" href="../reference/index.html">Function Reference</a></li>
    <li><a class="dropdown-item" href="../news/index.html">Release Notes</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/yanisvdc/cramR" aria-label="GitHub repository"><span class="fa fa-brands fa-github"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://arxiv.org/abs/2403.07031" aria-label="Research paper"><span class="fa fa-solid fa-file-pdf"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<link href="cram_policy_simulation_files/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="cram_policy_simulation_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="cram_policy_simulation_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="cram_policy_simulation_files/datatables-binding-0.33/datatables.js"></script><link href="cram_policy_simulation_files/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="cram_policy_simulation_files/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="cram_policy_simulation_files/dt-core-1.13.6/js/jquery.dataTables.min.js"></script><link href="cram_policy_simulation_files/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="cram_policy_simulation_files/crosstalk-1.2.1/js/crosstalk.min.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Using cram_simulation() for CRAM with Known DGP</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/yanisvdc/cramR/blob/HEAD/vignettes/cram_policy_simulation.Rmd" class="external-link"><code>vignettes/cram_policy_simulation.Rmd</code></a></small>
      <div class="d-none name"><code>cram_policy_simulation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="what-is-cram_simulation">ðŸŽ¯ What is <code>cram_simulation()</code>?<a class="anchor" aria-label="anchor" href="#what-is-cram_simulation"></a>
</h2>
<p>The <code><a href="../reference/cram_simulation.html">cram_simulation()</a></code> function performs
<strong>simultaneous policy learning and evaluation</strong> under a
<strong>known data-generating process (DGP)</strong>. It is useful
for:</p>
<ul>
<li>Benchmarking CRAM on simulated datasets</li>
<li>Measuring empirical <strong>bias</strong>,
<strong>variance</strong>, and <strong>confidence interval
coverage</strong>
</li>
<li>Supporting both synthetic (<code>dgp_X</code>) and empirical
(<code>X</code>) covariate generation</li>
</ul>
<hr>
</div>
<div class="section level2">
<h2 id="inputs-overview">ðŸ“¦ Inputs Overview<a class="anchor" aria-label="anchor" href="#inputs-overview"></a>
</h2>
<p>You must supply either: - <code>X</code>: a dataset to bootstrap from
(empirical DGP)<br><strong>or</strong> - <code>dgp_X</code>: a function that simulates
covariates</p>
<p>You must also define: - <code>dgp_D(X)</code>: treatment assignment
function<br>
- <code>dgp_Y(D, X)</code>: outcome generation function</p>
<hr>
</div>
<div class="section level2">
<h2 id="example-simulated-data-with-binary-discrete-and-continuous-covariates">ðŸ“˜ Example: Simulated Data with Binary, Discrete, and Continuous
Covariates<a class="anchor" aria-label="anchor" href="#example-simulated-data-with-binary-discrete-and-continuous-covariates"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define data generation process (DGP) functions</span></span>
<span><span class="va">X_data</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>  binary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>,                 <span class="co"># Binary variable (0 or 1)</span></span>
<span>  discrete <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,  <span class="co"># Discrete variable (1 to 5)</span></span>
<span>  continuous <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>                       <span class="co"># Continuous variable</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">dgp_D</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dgp_Y</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">D</span>, <span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>    <span class="va">X</span><span class="op">[</span>, <span class="va">binary</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">X</span><span class="op">[</span>, <span class="va">discrete</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="fl">2</span>,  <span class="co"># Group 1: High benefit</span></span>
<span>    <span class="fl">1</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="va">binary</span><span class="op">]</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">X</span><span class="op">[</span>, <span class="va">discrete</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="fl">4</span>,  <span class="co"># Group 3: High adverse effect</span></span>
<span>           <span class="op">-</span><span class="fl">1</span>,</span>
<span>           <span class="fl">0.1</span><span class="op">)</span>  <span class="co"># Group 2: Neutral effect</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">D</span> <span class="op">*</span> <span class="op">(</span><span class="va">theta</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">D</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Outcome for untreated</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Parameters</span></span>
<span><span class="va">nb_simulations</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">nb_simulations_truth</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">batch</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span></span>
<span><span class="co"># Perform CRAM simulation</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cram_simulation.html">cram_simulation</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">X_data</span>,</span>
<span>  dgp_D <span class="op">=</span> <span class="va">dgp_D</span>,</span>
<span>  dgp_Y <span class="op">=</span> <span class="va">dgp_Y</span>,</span>
<span>  batch <span class="op">=</span> <span class="va">batch</span>,</span>
<span>  nb_simulations <span class="op">=</span> <span class="va">nb_simulations</span>,</span>
<span>  nb_simulations_truth <span class="op">=</span> <span class="va">nb_simulations_truth</span>,</span>
<span>  sample_size <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Access results</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">avg_delta_estimate</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">delta_empirical_bias</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<hr>
</div>
<div class="section level2">
<h2 id="output-summary">ðŸ“Š Output Summary<a class="anchor" aria-label="anchor" href="#output-summary"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span><span class="op">$</span><span class="va">raw_results</span></span>
<span><span class="co">#&gt;                                  Metric    Value</span></span>
<span><span class="co">#&gt; 1            Average Proportion Treated  0.60000</span></span>
<span><span class="co">#&gt; 2                Average Delta Estimate -0.00705</span></span>
<span><span class="co">#&gt; 3          Average Delta Standard Error  0.23362</span></span>
<span><span class="co">#&gt; 4                  Delta Empirical Bias  0.12369</span></span>
<span><span class="co">#&gt; 5              Delta Empirical Coverage  1.00000</span></span>
<span><span class="co">#&gt; 6         Variance Delta Empirical Bias  0.42625</span></span>
<span><span class="co">#&gt; 7         Average Policy Value Estimate -0.00444</span></span>
<span><span class="co">#&gt; 8   Average Policy Value Standard Error  0.24662</span></span>
<span><span class="co">#&gt; 9           Policy Value Empirical Bias  0.06418</span></span>
<span><span class="co">#&gt; 10      Policy Value Empirical Coverage  0.90000</span></span>
<span><span class="co">#&gt; 11 Variance Policy Value Empirical Bias  0.33513</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span><span class="op">$</span><span class="va">interactive_table</span></span></code></pre></div>
<div class="datatables html-widget html-fill-item" id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"filter":"none","vertical":false,"caption":"<caption>CRAM Simulation Results<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10","11"],["Average Proportion Treated","Average Delta Estimate","Average Delta Standard Error","Delta Empirical Bias","Delta Empirical Coverage","Variance Delta Empirical Bias","Average Policy Value Estimate","Average Policy Value Standard Error","Policy Value Empirical Bias","Policy Value Empirical Coverage","Variance Policy Value Empirical Bias"],[0.6,-0.00705,0.23362,0.12369,1,0.42625,-0.00444,0.24662,0.06418,0.9,0.33513]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Metric<\/th>\n      <th>Value<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"Metric","targets":1},{"name":"Value","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>Returns a list containing:</p>
<ul>
<li>
<code>raw_results</code>: A summary of key averaged metrics<br>
</li>
<li>
<code>interactive_table</code>: An interactive HTML widget for quick
exploration</li>
</ul>
<table class="table">
<colgroup>
<col width="43%">
<col width="56%">
</colgroup>
<thead><tr class="header">
<th>Metric</th>
<th>Meaning</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Average Proportion Treated</td>
<td>Share of samples treated by learned policy</td>
</tr>
<tr class="even">
<td>Average Delta Estimate</td>
<td>Mean treatment effect (Î”) estimate</td>
</tr>
<tr class="odd">
<td>Delta Empirical Bias</td>
<td>Bias of Î” estimate against truth</td>
</tr>
<tr class="even">
<td>Delta Empirical Coverage</td>
<td>CI coverage of Î” estimate</td>
</tr>
<tr class="odd">
<td>Average Policy Value Estimate</td>
<td>Mean value of final policy</td>
</tr>
<tr class="even">
<td>Policy Value Empirical Bias</td>
<td>Bias against true policy value</td>
</tr>
<tr class="odd">
<td>Policy Value Empirical Coverage</td>
<td>CI coverage of policy value</td>
</tr>
</tbody>
</table>
<hr>
</div>
<div class="section level2">
<h2 id="notes">ðŸ’¡ Notes<a class="anchor" aria-label="anchor" href="#notes"></a>
</h2>
<ul>
<li>Uses <strong>batch splitting</strong> for honest policy
learning</li>
<li>Variance estimates use <strong>influence-function-based
asymptotics</strong>
</li>
<li>Simulations are grouped by <code>sim_id</code> and averaged</li>
<li>You can plug in <code>custom_fit</code> and
<code>custom_predict</code> if needed</li>
</ul>
<hr>
</div>
<div class="section level2">
<h2 id="see-also">ðŸ“š See Also<a class="anchor" aria-label="anchor" href="#see-also"></a>
</h2>
<ul>
<li>
<code><a href="../reference/cram_policy.html">cram_policy()</a></code> â€” for CRAM on real
experimental/observational data<br>
</li>
<li>
<code><a href="../reference/cram_bandit_sim.html">cram_bandit_sim()</a></code> â€” for contextual bandits<br>
</li>
<li>
<code><a href="../reference/cram_ml.html">cram_ml()</a></code> â€” for general supervised or unsupervised
ML</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Yanis Vandecasteele, Michael Lingzhi Li, Kosuke Imai, Zeyang Jia.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
