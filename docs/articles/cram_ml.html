<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Cram ML ‚Ä¢ cramR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Cram ML">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Load Inter font --><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&amp;display=swap" rel="stylesheet">
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #2c3e50, #3498db);
    --hover-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }

  .navbar {
    background-color: rgba(255, 255, 255, 0.95); /* Light background with slight transparency */
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); /* Optional shadow for depth */
  }

  body {
    padding-top: 80px;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }

  h1, h2, h3, h4, h5, h6 {
    font-family: 'Inter', sans-serif;
  }

  code, pre, kbd {
    font-family: 'JetBrains Mono', monospace;
    background-color: #f5f5f5;
    padding: 0.2em 0.4em;
    border-radius: 4px;
    font-size: 90%;
  }

  pre {
    overflow-x: auto;
  }

  pre code {
    padding: 1em;
    display: block;
  }

  .navbar-brand img {
    height: 40px;
    transition: transform 0.3s ease;
  }

  .navbar-brand:hover img {
    transform: scale(1.05);
  }

  .hero-banner {
    background: var(--primary-gradient);
    padding: 6rem 1rem;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .feature-card {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin: 1rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }

  .feature-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--hover-shadow);
  }

  /* Add hover effect to make the navbar more readable */
  .navbar:hover {
    background-color: rgba(255, 255, 255, 1); /* Fully visible on hover */
  }

  /* Add space below the navbar to prevent cutting off content */
  main {
    padding-top: 1rem;
  }
</style>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cramR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/cram_policy_part_1.html">Introduction &amp; Cram Policy part 1</a></li>
    <li><a class="dropdown-item" href="../articles/quickstart.html">Quick Start</a></li>
    <li><a class="dropdown-item" href="../articles/cram_policy_part_2.html">Cram Policy part 2</a></li>
    <li><a class="dropdown-item" href="../articles/cram_ml.html">Cram ML</a></li>
    <li><a class="dropdown-item" href="../articles/cram_bandit.html">Cram Bandit</a></li>
    <li><a class="dropdown-item" href="../articles/cram_bandit_helpers.html">Cram Bandit Helpers</a></li>
    <li><a class="dropdown-item" href="../articles/cram_policy_simulation.html">Cram Policy Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/cram_bandit_simulation.html">Cram Bandit Simulation</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-resources" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Resources</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-resources">
<li><a class="dropdown-item" href="../reference/index.html">Function Reference</a></li>
    <li><a class="dropdown-item" href="../news/index.html">Release Notes</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/yanisvdc/cramR" aria-label="GitHub repository"><span class="fa fa-brands fa-github"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://www.hbs.edu/ris/Publication%20Files/2403.07031v1_a83462e0-145b-4675-99d5-9754aa65d786.pdf" aria-label="Research paper"><span class="fa fa-solid fa-file-pdf"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Cram ML</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/yanisvdc/cramR/blob/HEAD/vignettes/cram_ml.Rmd" class="external-link"><code>vignettes/cram_ml.Rmd</code></a></small>
      <div class="d-none name"><code>cram_ml.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="cram-ml">Cram ML<a class="anchor" aria-label="anchor" href="#cram-ml"></a>
</h2>
<p>In the article <em>‚ÄúIntroduction &amp; Cram Policy Part 1‚Äù</em>, we
introduced the Cram method, which enables simultaneous learning and
evaluation of a binary policy. In this section, we extend the framework
to machine learning tasks through the <code><a href="../reference/cram_ml.html">cram_ml()</a></code>
function.</p>
<div class="section level3">
<h3 id="output-of-cram-ml">Output of Cram ML<a class="anchor" aria-label="anchor" href="#output-of-cram-ml"></a>
</h3>
<p>Cram ML outputs the <strong>Expected Loss Estimate</strong>, which
refers to the following statistical quantity:<br><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>ùîº</mi><mrow><mover><mi>X</mi><mo accent="true">ÃÉ</mo></mover><mo>‚àº</mo><mi>D</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">[</mo><mi>L</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>X</mi><mo accent="true">ÃÉ</mo></mover><mo>,</mo><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">
R(\hat{\pi}) = \mathbb{E}_{\tilde{X} \sim D} \left[ L(\tilde{X}, \hat{\pi}) \right],
</annotation></semantics></math> The Expected Loss Estimate represents
the average loss that would be incurred if a model, trained on a given
data sample, were deployed across the entire population. In the Cram
framework, this corresponds to estimating how the learned model
generalizes to unseen data‚Äîi.e., how it performs on new observations
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>X</mi><mo accent="true">ÃÉ</mo></mover><annotation encoding="application/x-tex">\tilde{X}</annotation></semantics></math>
drawn from the true data-generating distribution
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>,
independently of the training data.</p>
<p>This expected loss serves as the <strong>population-level
performance</strong> metric (analogous to a policy value in policy
learning), and Cram provides a <strong>consistent, low-bias
estimate</strong> of this quantity by combining models trained on
sequential batches and evaluating them on held-out observations.</p>
</div>
<div class="section level3">
<h3 id="built-in-model">Built-in Model<a class="anchor" aria-label="anchor" href="#built-in-model"></a>
</h3>
<p>To illustrate the use of <code><a href="../reference/cram_ml.html">cram_ml()</a></code>, we begin by
generating a synthetic dataset for a regression task. The data consists
of three independent covariates and a continuous outcome.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">X_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, x3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Y_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">data_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_data</span>, Y <span class="op">=</span> <span class="va">Y_data</span><span class="op">)</span></span></code></pre></div>
<p>This section illustrates how to use <code><a href="../reference/cram_ml.html">cram_ml()</a></code> with
built-in modeling options available through the <code>cramR</code>
package. The function integrates with the <code>caret</code> framework,
allowing users to specify a learning algorithm, a loss function, and a
batching strategy to evaluate model performance.</p>
<p>Beyond <code>caret</code>, <code><a href="../reference/cram_ml.html">cram_ml()</a></code> also supports fully
custom model training, prediction, and loss functions, making it
suitable for virtually any machine learning task ‚Äî including regression
and classification.</p>
<p>The <code><a href="../reference/cram_ml.html">cram_ml()</a></code> function offers extensive flexibility
through its <code>loss_name</code> and <code>caret_params</code>
arguments.</p>
<div class="section level4">
<h4 id="loss_name-argument">loss_name argument<a class="anchor" aria-label="anchor" href="#loss_name-argument"></a>
</h4>
<p>The <code>loss_name</code> argument specifies the performance metric
used to evaluate the model at each batch. Note that Cram needs to
calculate individual losses (i.e.¬†map a data point and prediction to a
loss value) that are then internally averaged across batches and
observations to form the <strong>Expected Loss Estimate</strong>.
Depending on the task, losses are interpreted as follows:</p>
<p>We denote
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mi>i</mi></msub><annotation encoding="application/x-tex">x_i</annotation></semantics></math>
a data point and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mi>k</mi></msub><annotation encoding="application/x-tex">\hat{\pi}_k</annotation></semantics></math>
a model trained on the first k batches of data to illustrate how the
individual losses are computed using the built-in loss names of the
package.</p>
<div class="section level5">
<h5 id="regression-losses">Regression Losses<a class="anchor" aria-label="anchor" href="#regression-losses"></a>
</h5>
<ul>
<li><p><strong>Squared Error (<code>"se"</code>)</strong>:<br><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>,</mo><msub><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>y</mi><mo accent="true">ÃÇ</mo></mover><mi>i</mi></msub><mo>‚àí</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">
L(x_i, \hat{\pi}_k) = (\hat{y}_i - y_i)^2
</annotation></semantics></math> Measures the squared difference between
predicted and actual outcomes.</p></li>
<li><p><strong>Absolute Error (<code>"ae"</code>)</strong>:<br><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>,</mo><msub><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mover><mi>y</mi><mo accent="true">ÃÇ</mo></mover><mi>i</mi></msub><mo>‚àí</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">|</mo></mrow></mrow><annotation encoding="application/x-tex">
L(x_i, \hat{\pi}_k) = |\hat{y}_i - y_i|
</annotation></semantics></math> Captures the magnitude of prediction
error, regardless of direction.</p></li>
</ul>
</div>
<div class="section level5">
<h5 id="classification-losses">Classification Losses<a class="anchor" aria-label="anchor" href="#classification-losses"></a>
</h5>
<ul>
<li><p><strong>Accuracy (<code>"accuracy"</code>)</strong>:<br><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>,</mo><msub><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>1</mn><mo stretchy="false" form="prefix">{</mo><msub><mover><mi>y</mi><mo accent="true">ÃÇ</mo></mover><mi>i</mi></msub><mo>=</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">
L(x_i, \hat{\pi}_k) = 1\{\hat{y}_i = y_i\}
</annotation></semantics></math> It is more a performance metric than a
loss here - Cram allows you to define any performance metric that you
want to estimate and accuracy is a built-in example. The metric is 1 for
correct predictions, 0 for incorrect ones.</p></li>
<li>
<p><strong>Logarithmic Loss (<code>"logloss"</code>)</strong>:</p>
<p>The <code>"logloss"</code> loss function measures how well predicted
class probabilities align with the true class labels. It applies to
<strong>both binary and multiclass classification tasks</strong>.</p>
<p>For a given observation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>,
let:</p>
<ul>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>‚àà</mo><mo stretchy="false" form="prefix">{</mo><msub><mi>c</mi><mn>1</mn></msub><mo>,</mo><msub><mi>c</mi><mn>2</mn></msub><mo>,</mo><mi>‚Ä¶</mi><mo>,</mo><msub><mi>c</mi><mi>K</mi></msub><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">y_i \in \{c_1, c_2, \dots, c_K\}</annotation></semantics></math>
be the <strong>true class label</strong>,</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>p</mi><mo accent="true">ÃÇ</mo></mover><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>c</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\hat{p}_k(i, c)</annotation></semantics></math>
be the <strong>predicted probability</strong> assigned to class
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>
by the model.</p></li>
</ul>
<p>The individual log loss is computed as:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>,</mo><msub><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>‚àí</mi><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>p</mi><mo accent="true">ÃÇ</mo></mover><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
L(x_i, \hat{\pi}_k) = -\log\left( \hat{p}_k(i, y_i) \right)
</annotation></semantics></math> That is, we take the negative log of
the probability assigned to the true class.</p>
</li>
</ul>
</div>
<div class="section level5">
<h5 id="custom-loss-functions">Custom Loss Functions<a class="anchor" aria-label="anchor" href="#custom-loss-functions"></a>
</h5>
<p>Users can also define their own custom loss function by providing a
<code>custom_loss(predictions, data)</code> function that returns a
vector of individual losses. This allows evaluation of complex models
with domain-specific metrics (more details in the Custom Model part
below)</p>
</div>
</div>
<div class="section level4">
<h4 id="caret_params-argument">caret_params argument<a class="anchor" aria-label="anchor" href="#caret_params-argument"></a>
</h4>
<p>The <code>caret_params</code> list defines how the model should be
trained using the <a href="https://topepo.github.io/caret/model-training-and-tuning.html" class="external-link"><code>caret</code></a>
package. It can include <strong>any argument supported by
<code><a href="https://rdrr.io/pkg/caret/man/train.html" class="external-link">caret::train()</a></code></strong>, allowing full control over model
specification and tuning. Common components include:</p>
<ul>
<li>
<code>method</code>: the machine learning algorithm (e.g.,
<code>"lm"</code> for linear regression, <code>"rf"</code> for random
forest, <code>"xgbTree"</code> for XGBoost, <code>"svmLinear"</code> for
support vector machines)</li>
<li>
<code>trControl</code>: the resampling strategy (e.g.,
<code>trainControl(method = "cv", number = 5)</code> for 5-fold
cross-validation, or <code>"none"</code> for training without
resampling)</li>
<li>
<code>tuneGrid</code>: a grid of hyperparameters for tuning (e.g.,
<code>expand.grid(mtry = c(2, 3, 4))</code>)</li>
<li>
<code>metric</code>: the model selection metric used during tuning
(e.g., <code>"RMSE"</code> or <code>"Accuracy"</code>)</li>
<li>
<code>preProcess</code>: optional preprocessing steps (e.g.,
centering, scaling)</li>
<li>
<code>importance</code>: logical flag to compute variable importance
(useful for tree-based models)</li>
</ul>
<p>Refer to the full documentation at <a href="https://topepo.github.io/caret/model-training-and-tuning.html" class="external-link">caret
model training and tuning</a> for the complete list of supported
arguments and options.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">caret_params_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="st">"lm"</span>,</span>
<span>  trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cram_ml.html">cram_ml</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">data_df</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>  batch <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  loss_name <span class="op">=</span> <span class="st">"se"</span>,</span>
<span>  caret_params <span class="op">=</span> <span class="va">caret_params_lm</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="co">#&gt; $raw_results</span></span>
<span><span class="co">#&gt;                         Metric    Value</span></span>
<span><span class="co">#&gt; 1       Expected Loss Estimate  0.86429</span></span>
<span><span class="co">#&gt; 2 Expected Loss Standard Error  0.73665</span></span>
<span><span class="co">#&gt; 3       Expected Loss CI Lower -0.57952</span></span>
<span><span class="co">#&gt; 4       Expected Loss CI Upper  2.30809</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $interactive_table</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $final_ml_model</span></span>
<span><span class="co">#&gt; Linear Regression </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 100 samples</span></span>
<span><span class="co">#&gt;   3 predictor</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; No pre-processing</span></span>
<span><span class="co">#&gt; Resampling: None</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="case-of-categorical-target-variable">Case of categorical target variable<a class="anchor" aria-label="anchor" href="#case-of-categorical-target-variable"></a>
</h4>
<p>The <code><a href="../reference/cram_ml.html">cram_ml()</a></code> function can also be used for
<strong>classification tasks</strong>, whether predicting hard labels or
class probabilities. This is controlled via the <code>classify</code>
argument and <code>loss_name</code>. Below, we demonstrate two typical
use cases.</p>
<p>Also note that all data inputs needs to be of numeric types, hence
for <code>Y</code> categorical, it should contain numeric values
representing the class of each observation. No need to use the type
<code>factor</code> for <code><a href="../reference/cram_ml.html">cram_ml()</a></code>.</p>
<div class="section level5">
<h5 id="case-1-predicting-class-labels">Case 1: Predicting Class Labels<a class="anchor" aria-label="anchor" href="#case-1-predicting-class-labels"></a>
</h5>
<p>In this case, the model outputs hard predictions (labels, e.g.¬†0, 1,
2 etc.), and the metric used is <strong>classification
accuracy</strong>‚Äîthe proportion of correctly predicted labels.</p>
<ul>
<li>Use <code>loss_name = "accuracy"</code>
</li>
<li>Set <code>classProbs = FALSE</code> in
<code>trainControl</code>
</li>
<li>Set <code>classify = TRUE</code> in <code><a href="../reference/cram_ml.html">cram_ml()</a></code>
</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate binary classification dataset</span></span>
<span><span class="va">X_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, x3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Y_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_data</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">data_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_data</span>, Y <span class="op">=</span> <span class="va">Y_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define caret parameters: predict labels (default behavior)</span></span>
<span><span class="va">caret_params_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="st">"rf"</span>,</span>
<span>  trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run CRAM ML with accuracy as loss</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cram_ml.html">cram_ml</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">data_df</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>  batch <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  loss_name <span class="op">=</span> <span class="st">"accuracy"</span>,</span>
<span>  caret_params <span class="op">=</span> <span class="va">caret_params_rf</span>,</span>
<span>  classify <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="co">#&gt; $raw_results</span></span>
<span><span class="co">#&gt;                         Metric    Value</span></span>
<span><span class="co">#&gt; 1       Expected Loss Estimate  0.48750</span></span>
<span><span class="co">#&gt; 2 Expected Loss Standard Error  0.43071</span></span>
<span><span class="co">#&gt; 3       Expected Loss CI Lower -0.35668</span></span>
<span><span class="co">#&gt; 4       Expected Loss CI Upper  1.33168</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $interactive_table</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $final_ml_model</span></span>
<span><span class="co">#&gt; Random Forest </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 100 samples</span></span>
<span><span class="co">#&gt;   3 predictor</span></span>
<span><span class="co">#&gt;   2 classes: 'class0', 'class1' </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; No pre-processing</span></span>
<span><span class="co">#&gt; Resampling: None</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="case-2-predicting-class-probabilities">Case 2: Predicting Class Probabilities<a class="anchor" aria-label="anchor" href="#case-2-predicting-class-probabilities"></a>
</h5>
<p>In this setup, the model outputs <strong>class
probabilities</strong>, and the loss is evaluated using
<strong>logarithmic loss (<code>logloss</code>)</strong>‚Äîa standard
metric for probabilistic classification.</p>
<ul>
<li>Use <code>loss_name = "logloss"</code>
</li>
<li>Set <code>classProbs = TRUE</code> in <code>trainControl</code>
</li>
<li>Set <code>classify = TRUE</code> in <code><a href="../reference/cram_ml.html">cram_ml()</a></code>
</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate binary classification dataset</span></span>
<span><span class="va">X_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, x3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Y_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_data</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">data_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_data</span>, Y <span class="op">=</span> <span class="va">Y_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define caret parameters for probability output</span></span>
<span><span class="va">caret_params_rf_probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="st">"rf"</span>,</span>
<span>  trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"none"</span>, classProbs <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run CRAM ML with logloss as the evaluation loss</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cram_ml.html">cram_ml</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">data_df</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>  batch <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  loss_name <span class="op">=</span> <span class="st">"logloss"</span>,</span>
<span>  caret_params <span class="op">=</span> <span class="va">caret_params_rf_probs</span>,</span>
<span>  classify <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="co">#&gt; $raw_results</span></span>
<span><span class="co">#&gt;                         Metric    Value</span></span>
<span><span class="co">#&gt; 1       Expected Loss Estimate  0.93225</span></span>
<span><span class="co">#&gt; 2 Expected Loss Standard Error  0.48118</span></span>
<span><span class="co">#&gt; 3       Expected Loss CI Lower -0.01085</span></span>
<span><span class="co">#&gt; 4       Expected Loss CI Upper  1.87534</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $interactive_table</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $final_ml_model</span></span>
<span><span class="co">#&gt; Random Forest </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 100 samples</span></span>
<span><span class="co">#&gt;   3 predictor</span></span>
<span><span class="co">#&gt;   2 classes: 'class0', 'class1' </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; No pre-processing</span></span>
<span><span class="co">#&gt; Resampling: None</span></span></code></pre></div>
<p>Together, these arguments allow users to apply <code><a href="../reference/cram_ml.html">cram_ml()</a></code>
using a wide variety of built-in machine learning models and losses. If
users need to go beyond these built-in choices, we also provide in the
next section a friendly workflow on how to specify custom models and
losses with <code><a href="../reference/cram_ml.html">cram_ml()</a></code>.</p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="custom-model">Custom Model<a class="anchor" aria-label="anchor" href="#custom-model"></a>
</h3>
<p>In addition to using built-in learners via <code>caret</code>,
<code><a href="../reference/cram_ml.html">cram_ml()</a></code> also supports <strong>fully custom model
workflows</strong>. You can specify your own:</p>
<ul>
<li>Model fitting function (<code>custom_fit</code>)</li>
<li>Prediction function (<code>custom_predict</code>)</li>
<li>Loss function (<code>custom_loss</code>)</li>
</ul>
<p>This offers maximum flexibility, allowing CRAM to evaluate any
learning model with any performance criterion, including regression,
classification, or even unsupervised losses such as clustering
distance.</p>
<hr>
<div class="section level4">
<h4 id="custom_fitdata----">1. <code>custom_fit(data, ...)</code><a class="anchor" aria-label="anchor" href="#custom_fitdata----"></a>
</h4>
<p>This function takes a data frame and returns a fitted model. You may
define additional arguments such as hyperparameters or training
settings.</p>
<ul>
<li>
<code>data</code>: A data frame that includes both predictors and
the outcome variable <code>Y</code>.</li>
</ul>
<p><strong>Example</strong>: A basic linear model fit on three
predictors:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_fit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">x3</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="custom_predictmodel-data">2. <code>custom_predict(model, data)</code><a class="anchor" aria-label="anchor" href="#custom_predictmodel-data"></a>
</h4>
<p>This function generates predictions from the fitted model on new
data. It returns a numeric vector of predicted outcomes.</p>
<ul>
<li>
<code>model</code>: The fitted model returned by
<code>custom_fit()</code>
</li>
<li>
<code>data</code>: A data frame of new observations (typically
including all original predictors)</li>
</ul>
<p><strong>Example</strong>: Extract predictors and apply a standard
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> call:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_predict</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">predictors_only</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="st">"Y"</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, newdata <span class="op">=</span> <span class="va">predictors_only</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="custom_losspredictions-data">3. <code>custom_loss(predictions, data)</code><a class="anchor" aria-label="anchor" href="#custom_losspredictions-data"></a>
</h4>
<p>This function defines the loss metric used to evaluate model
predictions. It should return a numeric vector of <strong>individual
losses</strong>, one per observation. These are internally aggregated by
<code><a href="../reference/cram_ml.html">cram_ml()</a></code> to compute the overall performance.</p>
<ul>
<li>
<code>predictions</code>: A numeric vector of predicted values from
the model</li>
<li>
<code>data</code>: The data frame containing the true outcome values
(<code>Y</code>)</li>
</ul>
<p><strong>Example</strong>: Define a custom loss function using
<strong>Squared Error (SE)</strong></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_loss</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">predictions</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">actuals</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span></span>
<span>  <span class="va">se_loss</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">predictions</span> <span class="op">-</span> <span class="va">actuals</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">se_loss</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="use-cram_ml-with-custom-functions">4. Use <code>cram_ml()</code> with Custom Functions<a class="anchor" aria-label="anchor" href="#use-cram_ml-with-custom-functions"></a>
</h4>
<p>Once you have defined your custom training, prediction, and loss
functions, you can pass them directly to <code><a href="../reference/cram_ml.html">cram_ml()</a></code> as shown
below, note that <code>caret_params</code> and <code>loss_name</code>
that were used for built-in functionalities are now
<code>NULL</code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cram_ml.html">cram_ml</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">data_df</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>  batch <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  custom_fit <span class="op">=</span> <span class="va">custom_fit</span>,</span>
<span>  custom_predict <span class="op">=</span> <span class="va">custom_predict</span>,</span>
<span>  custom_loss <span class="op">=</span> <span class="va">custom_loss</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="co">#&gt; $raw_results</span></span>
<span><span class="co">#&gt;                         Metric   Value</span></span>
<span><span class="co">#&gt; 1       Expected Loss Estimate 0.24315</span></span>
<span><span class="co">#&gt; 2 Expected Loss Standard Error 0.05615</span></span>
<span><span class="co">#&gt; 3       Expected Loss CI Lower 0.13309</span></span>
<span><span class="co">#&gt; 4       Expected Loss CI Upper 0.35321</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $interactive_table</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $final_ml_model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ x1 + x2 + x3, data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)           x1           x2           x3  </span></span>
<span><span class="co">#&gt;   0.4625378    0.0418039   -0.0696723   -0.0007469</span></span></code></pre></div>
<hr>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Yanis Vandecasteele, Michael Lingzhi Li, Kosuke Imai, Zeyang Jia, Longlin Wang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
